<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Piano Request Checker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #1a202c;
      color: #e2e8f0;
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
    }
    .main-container {
      max-width: 1024px;
      margin: 0 auto;
      padding: 2rem;
    }
    .card {
      background-color: #2d3748;
      border-radius: 0.5rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.75);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
    .modal-content {
      background-color: #2d3748;
      padding: 2rem;
      border-radius: 0.5rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #63b3ed;
      width: 3rem;
      height: 3rem;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "firebase/": "https://aistudiocdn.com/firebase@^12.5.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // --- UTILITY FUNCTIONS ---
    const parseSongs = (text) => {
      if (!text || typeof text !== 'string') return [];
      return text.split('\n').map(line => {
        const parts = line.split(',');
        return { title: parts[0]?.trim() || '', artist: parts[1]?.trim() || '' };
      }).filter(song => song.title);
    };

    const formatSongs = (songs) => {
      return songs.map(song => `${song.title},${song.artist}`).join('\n');
    };

    // --- ICON COMPONENTS ---
    const SearchIcon = () => (
      <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
    );
    const SettingsIcon = () => (
      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
    );

    // --- MAIN COMPONENTS ---

    function SettingsModal({ songs, onSave, onClose, onLogin, isAdmin, isDefaultPassword }) {
      const [password, setPassword] = useState('');
      const [songText, setSongText] = useState(formatSongs(songs));
      const [isSaving, setIsSaving] = useState(false);
      const [error, setError] = useState('');

      const handleSave = async () => {
        setIsSaving(true);
        setError('');
        try {
          const parsedSongs = parseSongs(songText);
          const formattedText = formatSongs(parsedSongs);
          setSongText(formattedText); // Normalize text before saving
          await onSave(formattedText);
          onClose();
        } catch (e) {
          setError(`保存に失敗しました: ${e.message}`);
        } finally {
          setIsSaving(false);
        }
      };
      
      const handleLogin = (e) => {
        e.preventDefault();
        onLogin(password);
      };

      if (!isAdmin) {
        return (
          <div className="modal-overlay">
            <div className="modal-content">
              <h2 className="text-xl font-bold mb-4">管理者ログイン</h2>
              {isDefaultPassword && (
                <div className="bg-yellow-900 border-l-4 border-yellow-500 text-yellow-100 p-4 mb-4 rounded">
                  <p className="font-bold">セキュリティ警告</p>
                  <p>初期パスワードが使用されています。コード内の<code className="bg-gray-800 px-1 rounded">ADMIN_PASSWORD</code>を変更してください。</p>
                </div>
              )}
              <form onSubmit={handleLogin}>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full bg-gray-700 text-white rounded p-2 mb-4"
                  placeholder="パスワード"
                />
                <div className="flex justify-end gap-2">
                  <button type="button" onClick={onClose} className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                    キャンセル
                  </button>
                  <button type="submit" className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                    ログイン
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      }

      return (
        <div className="modal-overlay">
          <div className="modal-content">
            <h2 className="text-xl font-bold mb-2">弾ける曲リストを編集</h2>
            <p className="text-sm text-gray-400 mb-4">
              1行に1曲、「曲名,アーティスト名」の形式で入力してください。
            </p>
            <textarea
              className="w-full h-64 bg-gray-800 text-white rounded p-2 font-mono text-sm"
              value={songText}
              onChange={(e) => setSongText(e.target.value)}
            />
            {error && <p className="text-red-400 mt-2">{error}</p>}
            <div className="flex justify-end gap-2 mt-4">
              <button onClick={onClose} disabled={isSaving} className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded disabled:opacity-50">
                キャンセル
              </button>
              <button onClick={handleSave} disabled={isSaving} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded disabled:opacity-50">
                {isSaving ? '保存中...' : '保存して閉じる'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    function SearchBar({ value, onChange }) {
      return (
        <div className="relative">
          <input
            type="text"
            placeholder="曲名やアーティスト名で検索..."
            className="w-full bg-gray-700 text-white rounded-full py-3 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={value}
            onChange={(e) => onChange(e.target.value)}
          />
          <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <SearchIcon />
          </div>
        </div>
      );
    }

    function ResultsDisplay({ filteredSongs, query }) {
      const GAKUFU_URL = `https://www.print-gakufu.com/search/result/score___keyword__${encodeURIComponent(query)}___subscription/`;

      return (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
          <div className="card">
            <h2 className="text-lg font-bold mb-4">あなたの弾ける曲リスト</h2>
            {query && filteredSongs.length > 0 && (
              <ul className="space-y-2">
                {filteredSongs.map((song, index) => (
                  <li key={index} className="p-2 bg-gray-700 rounded">
                    <span className="font-semibold">{song.title}</span>
                    <span className="text-gray-400 ml-2">{song.artist}</span>
                  </li>
                ))}
              </ul>
            )}
            {query && filteredSongs.length === 0 && (
              <p className="text-gray-400">リスト内に見つかりませんでした。</p>
            )}
            {!query && (
              <p className="text-gray-400">検索すると、ここに結果が表示されます。</p>
            )}
          </div>
          <div className="card">
            <h2 className="text-lg font-bold mb-4">ヤマハ「ぷりんと楽譜」</h2>
            {query ? (
              <div>
                <p className="text-gray-300 mb-4">
                  「{query}」の検索結果を公式サイトで確認できます。
                </p>
                <a
                  href={GAKUFU_URL}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="inline-block bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded"
                >
                  公式サイトで検索結果を見る
                </a>
              </div>
            ) : (
              <p className="text-gray-400">
                検索すると、公式サイトへのリンクが表示されます。
              </p>
            )}
          </div>
        </div>
      );
    }
    
    function App() {
      const [songs, setSongs] = useState([]);
      const [initialSongs, setInitialSongs] = useState([]);
      const [searchQuery, setSearchQuery] = useState('');
      const [isLoading, setIsLoading] = useState(true);
      const [error, setError] = useState(null);
      const [isSettingsOpen, setIsSettingsOpen] = useState(false);
      const [isAdmin, setIsAdmin] = useState(false);
      
      // ▼▼▼【重要】このパスワードを、あなただけが知っている複雑なものに変更してください ▼▼▼
      const ADMIN_PASSWORD = "change_this_password"; 
      // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

      useEffect(() => {
        const fetchSongs = async () => {
          try {
            const response = await fetch('/api/songs');
            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`サーバーからのデータ取得に失敗しました。ステータス: ${response.status}. ${errorText}`);
            }
            const data = await response.json();
            const parsed = parseSongs(data.list_string);
            setSongs(parsed);
            setInitialSongs(parsed);
          } catch (e) {
            console.error("ドキュメントの読み込みエラー: ", e);
            setError(`データベースに接続できません。Cloudflareの環境変数やFirebaseのルールを確認してください。\nエラー詳細: ${e.message}\n\nそれでも解決しない場合は、ブラウザのキャッシュをクリア（Ctrl+Shift+R または Cmd+Shift+R）してみてください。`);
          } finally {
            setIsLoading(false);
          }
        };
        fetchSongs();
      }, []);

      const handleSaveSongs = async (songText) => {
        try {
          const response = await fetch('/api/songs', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ list_string: songText }),
          });
          if (!response.ok) {
            throw new Error('サーバーへのデータ保存に失敗しました。');
          }
          const parsed = parseSongs(songText);
          setSongs(parsed);
          setInitialSongs(parsed);
        } catch (e) {
          console.error("ドキュメントの保存エラー: ", e);
          alert(`保存に失敗しました: ${e.message}`);
          throw e; // Propagate error to modal
        }
      };
      
      const handleLogin = (password) => {
        if (password === ADMIN_PASSWORD) {
          setIsAdmin(true);
        } else {
          alert('パスワードが違います。');
        }
      };
      
      const isDefaultPassword = ADMIN_PASSWORD === "change_this_password";

      const filteredSongs = useMemo(() => {
        if (!searchQuery) return [];
        const lowerCaseQuery = searchQuery.toLowerCase();
        return songs.filter(
          song =>
            song.title.toLowerCase().includes(lowerCaseQuery) ||
            song.artist.toLowerCase().includes(lowerCaseQuery)
        );
      }, [searchQuery, songs]);

      if (isLoading) {
        return (
          <div className="flex justify-center items-center h-screen">
            <div className="loading-spinner"></div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="main-container text-center">
            <h1 className="text-2xl font-bold text-red-400 mb-4">エラーが発生しました</h1>
            <pre className="bg-gray-800 text-left p-4 rounded whitespace-pre-wrap">{error}</pre>
          </div>
        );
      }

      return (
        <div className="main-container">
          <header className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-white">Piano Request Checker</h1>
            <button onClick={() => setIsSettingsOpen(true)} className="text-gray-400 hover:text-white">
              <SettingsIcon />
            </button>
          </header>

          <main>
            <SearchBar value={searchQuery} onChange={setSearchQuery} />
            <ResultsDisplay filteredSongs={filteredSongs} query={searchQuery} />
          </main>
          
          {isSettingsOpen && (
            <SettingsModal 
              songs={initialSongs} 
              onClose={() => {
                setIsSettingsOpen(false);
                setIsAdmin(false); // Reset admin state on close
              }}
              onSave={handleSaveSongs}
              onLogin={handleLogin}
              isAdmin={isAdmin}
              isDefaultPassword={isDefaultPassword}
            />
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));

  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>